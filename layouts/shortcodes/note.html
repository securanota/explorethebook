{{- $content := .Inner -}}
{{- $sources := split (.Get 0 | default "") "," -}}
{{- $footnoteId := printf "mixnote-%d" (.Page.Scratch.Get "footnote-counter" | default 0) -}}
{{- .Page.Scratch.Add "footnote-counter" 1 -}}
{{- $page := .Page -}}
{{- $siteData := .Site.Data -}}

<sup class="footnote-ref">
  <a href="#fn-{{ $footnoteId }}" class="footnote-link" aria-label="Note">{{ .Page.Scratch.Get "footnote-counter" }}</a>
</sup>

<span class="footnote-content" id="fn-{{ $footnoteId }}" style="display: none;">
  {{- $content | markdownify -}}
  {{- if and ($content) (ne (.Get 0 | default "") "") }} {{- end -}}
  {{- range $sources -}}
    {{- $parts := split . ":" -}}
    {{- $sourceId := index $parts 0 | strings.TrimSpace -}}
    {{- $pages := index $parts 1 | default "" | strings.TrimSpace -}}
    {{- if $sourceId -}}
      {{- $source := false -}}
      {{- $bibliographyFiles := $page.Params.bibliography_files | default (slice "bibliography") -}}
      {{- range $bibliographyFiles -}}
        {{- $bibData := index $siteData . -}}
        {{- if $bibData -}}
          {{- range $bibData -}}
            {{- if eq .id $sourceId -}}
              {{- $source = . -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
      {{- if $source -}}
        {{- if $source.author -}}
          {{ (index $source.author 0).family }}, {{ (index $source.author 0).given }}
        {{- end -}}
        , <em>{{ $source.title }}</em> (2024){{- if $pages }}, {{ $pages }}{{- end }}.
      {{- else -}}
        [{{ $sourceId }} - source not found]
      {{- end -}}
    {{- end -}}
  {{- end -}}
  <a href="#ref-{{ $footnoteId }}" class="footnote-backlink" aria-label="Return to text">â†©</a>
</span>